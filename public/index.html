<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ¬åœ°ç«¯å£ç®¡ç†å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display: flex; align-items: flex-start; justify-content: center;
      padding: 24px 20px 40px;
    }
    .container { background: #fff; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,.3); width: 100%; max-width: 980px; padding: 28px 40px; }
    .header { text-align: center; margin-bottom: 22px; }
    .header h1 { font-size: 26px; color: #333; margin-bottom: 6px; }
    .header p { color: #999; font-size: 13px; }

    .batch-actions { display: flex; gap: 12px; margin-bottom: 18px; padding-bottom: 14px; border-bottom: 2px solid #f0f0f0; }
    .batch-actions button { flex: 1; padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: .2s; }
    .btn-batch-start { background: #4CAF50; color: #fff; }
    .btn-batch-stop { background: #FF9800; color: #fff; }
    .btn-batch-delete { background: #f44336; color: #fff; }
    .btn-add-port { background: #2196F3; color: #fff; padding: 10px 22px; }
    .batch-actions button:hover { filter: brightness(.95); transform: translateY(-1px); }

    .ports-list { display: flex; flex-direction: column; gap: 10px; }
    .port-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #2196F3; transition: .2s; }
    .port-item.running { border-left-color: #4CAF50; }
    .port-item.stopped { border-left-color: #f44336; }
    .port-item:hover { background: #f0f8ff; box-shadow: 0 4px 12px rgba(0,0,0,.08); }

    .port-info { flex: 1; display: flex; align-items: center; gap: 18px; min-width: 0; }
    .port-remark { color: #333; font-size: 18px; font-weight: 600; max-width: 55%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .port-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
    .status-indicator.running { background: #4CAF50; }
    .status-indicator.stopped { background: #f44336; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .port-number { font-size: 12px; color: #e53935; min-width: 60px; text-align: right; }

    .port-actions { display: flex; gap: 8px; }
    .btn-action { padding: 7px 12px; border: none; border-radius: 5px; font-size: 13px; font-weight: 600; cursor: pointer; transition: .2s; white-space: nowrap; }
    .btn-start { background: #4CAF50; color: #fff; }
    .btn-stop { background: #FF9800; color: #fff; }
    .btn-edit { background: #6a5acd; color: #fff; }
    .btn-delete { background: #f44336; color: #fff; }
    .btn-action:hover { filter: brightness(.95); transform: translateY(-1px); }

    .empty-state { text-align: center; padding: 40px 20px; color: #999; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; border-radius: 12px; padding: 22px; width: 100%; max-width: 560px; box-shadow: 0 20px 60px rgba(0,0,0,.3); animation: slideIn .25s ease; }
    @keyframes slideIn { from{transform: translateY(-24px); opacity: 0} to{transform: translateY(0); opacity: 1} }
    .modal-header { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 14px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
    .form-group input, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    .form-group textarea { resize: vertical; min-height: 80px; font-family: 'Courier New', monospace; font-size: 12px; }
    .form-hint { font-size: 12px; color: #999; margin-top: 4px; }
    .modal-footer { display: flex; gap: 10px; margin-top: 12px; }
    .modal-footer button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-submit { background: #2196F3; color: #fff; }
    .btn-cancel { background: #f0f0f0; color: #333; }

    @media (max-width: 768px) {
      .container { padding: 18px; }
      .port-info { flex-direction: column; align-items: flex-start; gap: 8px; }
      .port-actions { width: 100%; }
      .port-actions .btn-action { flex: 1; }
      .port-remark { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ æœ¬åœ°ç«¯å£ç®¡ç†å·¥å…·</h1>
      <p>åœ¨ 127.0.0.1 ä¸Šç®¡ç†ä½ çš„æœ¬åœ°æœåŠ¡ç«¯å£</p>
    </div>

    <div class="batch-actions">
      <button class="btn-batch-start" onclick="batchStartAll()">â–¶ å…¨éƒ¨å¯åŠ¨</button>
      <button class="btn-batch-stop" onclick="batchStopAll()">â¹ å…¨éƒ¨é‡Šæ”¾</button>
      <button class="btn-batch-delete" onclick="batchDeleteAll()">ğŸ—‘ å…¨éƒ¨åˆ é™¤</button>
      <button class="btn-add-port" onclick="openAddModal()">â• æ–°å»ºç«¯å£</button>
    </div>

    <div class="ports-list" id="portsList"></div>
  </div>

  <!-- æ–°å»ºç«¯å£æ¨¡æ€æ¡† -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">æ–°å»ºç«¯å£</div>
      <form onsubmit="submitAddPort(event)">
        <div class="form-group">
          <label>ç«¯å£å· *</label>
          <input type="number" id="portInput" min="1" max="65535" required placeholder="ä¾‹å¦‚: 3000">
          <div class="form-hint">è¾“å…¥ 1-65535 ä¹‹é—´çš„ç«¯å£å·</div>
        </div>
        <div class="form-group">
          <label>å¯åŠ¨å‘½ä»¤</label>
          <textarea id="startCmdInput" placeholder="ä¾‹å¦‚: cd /d D:\\path && python -m http.server {port}"></textarea>
          <div class="form-hint">æ”¯æŒ {port} å ä½ç¬¦</div>
        </div>
        <div class="form-group">
          <label>é‡Šæ”¾å‘½ä»¤</label>
          <textarea id="stopCmdInput" placeholder="é»˜è®¤: PowerShell Stop-Process... å¯è‡ªå®šä¹‰"></textarea>
          <div class="form-hint">æ”¯æŒ {port} å ä½ç¬¦</div>
        </div>
        <div class="form-group">
          <label>æ—¥å¿—æ–‡ä»¶è·¯å¾„</label>
          <input type="text" id="logPathInput" placeholder="ä¾‹å¦‚: ~/Desktop/{port}.log">
          <div class="form-hint">æ”¯æŒ {port} å’Œ ~</div>
        </div>
        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="remarkInput" placeholder="ä¾‹å¦‚: å‰ç«¯å¼€å‘æœåŠ¡å™¨">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-submit">åˆ›å»º</button>
          <button type="button" class="btn-cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ç¼–è¾‘ç«¯å£æ¨¡æ€æ¡† -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">ç¼–è¾‘ç«¯å£</div>
      <form onsubmit="submitEditPort(event)">
        <input type="hidden" id="editId">
        <div class="form-group">
          <label>ç«¯å£å· *</label>
          <input type="number" id="editPort" min="1" max="65535" required>
        </div>
        <div class="form-group">
          <label>å¯åŠ¨å‘½ä»¤</label>
          <textarea id="editStartCmd"></textarea>
          <div class="form-hint">æ”¯æŒ {port} å ä½ç¬¦ï¼›è‹¥ä½ ç”¨ Uvicornï¼Œè¯·ç¡®ä¿å‘½ä»¤ç±»ä¼¼ï¼špython -m uvicorn main:app --host 0.0.0.0 --port {port}</div>
        </div>
        <div class="form-group">
          <label>é‡Šæ”¾å‘½ä»¤</label>
          <textarea id="editStopCmd"></textarea>
          <div class="form-hint">æ¨èï¼šfor /f "tokens=5" %p in ('netstat -ano ^| findstr ":{port}"') do taskkill /F /T /PID %p</div>
        </div>
        <div class="form-group">
          <label>æ—¥å¿—æ–‡ä»¶è·¯å¾„</label>
          <input type="text" id="editLogPath">
        </div>
        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="editRemark">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-submit">ä¿å­˜</button>
          <button type="button" class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let ports = [];

    const ws = new WebSocket(`ws://${window.location.host}`);
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.type === 'status_update') {
        // æœåŠ¡ç«¯æ¨é€çš„çŠ¶æ€åªåŒ…å« id/port/status/remark
        // ä¸ºäº†ä¿æŒæœ¬åœ°æ•°æ®å®Œæ•´æ€§ï¼Œç”¨ç°æœ‰ ports åˆå¹¶ status/remark/port
        const map = new Map(ports.map(p => [p.id, p]));
        message.data.forEach(s => {
          const old = map.get(s.id) || s;
          map.set(s.id, { ...old, ...s });
        });
        ports = Array.from(map.values());
        renderPorts();
      }
    };

    async function refreshPorts() {
      try {
        const res = await fetch('/api/ports');
        ports = await res.json();
        renderPorts();
      } catch (e) { showNotification('è·å–ç«¯å£åˆ—è¡¨å¤±è´¥', 'error'); }
    }

    function renderPorts() {
      const el = document.getElementById('portsList');
      if (!ports.length) {
        el.innerHTML = `<div class="empty-state">æš‚æ— ç«¯å£ï¼Œç‚¹å‡»â€œæ–°å»ºç«¯å£â€æ·»åŠ </div>`;
        return;
      }
      el.innerHTML = ports.map(port => `
        <div class="port-item ${port.status ? 'running' : 'stopped'}">
          <div class="port-info">
            ${port.remark ? `<div class=\"port-remark\">ğŸ“ ${port.remark}</div>` : `<div class=\"port-remark\">(æœªå¡«å†™å¤‡æ³¨)</div>`}
            <div class="port-status">
              <span class="status-indicator ${port.status ? 'running' : 'stopped'}"></span>
              <span>${port.status ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</span>
            </div>
            <div class="port-number">ç«¯å£: ${port.port}</div>
          </div>
          <div class="port-actions">
            <button class="btn-action btn-start" onclick="startPort('${port.id}')">â–¶ å¯åŠ¨</button>
            <button class="btn-action btn-stop" onclick="stopPort('${port.id}')">â¹ é‡Šæ”¾</button>
            <button class="btn-action btn-edit" onclick="openEditModal('${port.id}')">âœï¸ ç¼–è¾‘</button>
            <button class="btn-action btn-delete" onclick="deletePort('${port.id}')">ğŸ—‘ åˆ é™¤</button>
          </div>
        </div>`).join('');
    }

    // æ–°å»ºç«¯å£
    function openAddModal(){ document.getElementById('addModal').classList.add('active'); document.getElementById('portInput').focus(); }
    function closeAddModal(){ document.getElementById('addModal').classList.remove('active'); ['portInput','startCmdInput','stopCmdInput','logPathInput','remarkInput'].forEach(id => document.getElementById(id).value = ''); }
    async function submitAddPort(e){
      e.preventDefault();
      const body = {
        port: parseInt(document.getElementById('portInput').value),
        startCommand: document.getElementById('startCmdInput').value,
        stopCommand: document.getElementById('stopCmdInput').value,
        logPath: document.getElementById('logPathInput').value,
        remark: document.getElementById('remarkInput').value,
      };
      try {
        const res = await fetch('/api/ports', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
        closeAddModal();
        showNotification(`ç«¯å£ ${body.port} å·²åˆ›å»º`, 'success');
        refreshPorts();
      } catch(err){ showNotification(err.message, 'error'); }
    }

    // å¯åŠ¨/é‡Šæ”¾/åˆ é™¤
    async function startPort(id){
      try{
        const res = await fetch(`/api/ports/${id}/start`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å¯åŠ¨å¤±è´¥');
        showNotification('å¯åŠ¨å‘½ä»¤å·²åœ¨åå°æ‰§è¡Œï¼ˆæŸ¥çœ‹æ¡Œé¢æ—¥å¿—ï¼‰', 'success');
      }catch(err){ showNotification(err.message, 'error'); }
    }
    async function stopPort(id){
      try{
        const res = await fetch(`/api/ports/${id}/stop`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'é‡Šæ”¾å¤±è´¥');
        showNotification(data.message || 'é‡Šæ”¾å‘½ä»¤å·²æ‰§è¡Œ', 'success');
      }catch(err){ showNotification(err.message, 'error'); }
    }
    async function deletePort(id){
      const p = ports.find(x => x.id === id);
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç«¯å£ ${p?.port ?? ''} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
      try{
        const res = await fetch(`/api/ports/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
        showNotification(`ç«¯å£ ${p?.port ?? ''} å·²åˆ é™¤`, 'success');
        refreshPorts();
      }catch(err){ showNotification(err.message, 'error'); }
    }

    // ç¼–è¾‘ç«¯å£
    function openEditModal(id){
      fetch(`/api/ports/${id}`).then(r => r.json()).then(p => {
        if (p.error) throw new Error(p.error);
        document.getElementById('editId').value = p.id;
        document.getElementById('editPort').value = p.port;
        document.getElementById('editStartCmd').value = p.startCommand || '';
        document.getElementById('editStopCmd').value = p.stopCommand || '';
        document.getElementById('editLogPath').value = p.logPath || '';
        document.getElementById('editRemark').value = p.remark || '';
        document.getElementById('editModal').classList.add('active');
      }).catch(e => showNotification(e.message || 'æ‰“å¼€ç¼–è¾‘å¤±è´¥', 'error'));
    }
    function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); }
    async function submitEditPort(e){
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const body = {
        port: parseInt(document.getElementById('editPort').value),
        startCommand: document.getElementById('editStartCmd').value,
        stopCommand: document.getElementById('editStopCmd').value,
        logPath: document.getElementById('editLogPath').value,
        remark: document.getElementById('editRemark').value,
      };
      try{
        const res = await fetch(`/api/ports/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
        closeEditModal();
        showNotification('å·²ä¿å­˜ä¿®æ”¹', 'success');
        refreshPorts();
      }catch(err){ showNotification(err.message, 'error'); }
    }

    // æ‰¹é‡
    async function batchStartAll(){ if(!ports.length) return showNotification('æ²¡æœ‰å¯å¯åŠ¨çš„ç«¯å£','info'); if(!confirm(`ç¡®å®šè¦å¯åŠ¨å…¨éƒ¨ ${ports.length} ä¸ªç«¯å£å—ï¼Ÿ`)) return; const r=await fetch('/api/ports/batch/start-all',{method:'POST'}); const d=await r.json(); if(!r.ok) return showNotification(d.error||'æ‰¹é‡å¯åŠ¨å¤±è´¥','error'); const ok=d.results.filter(x=>x.success).length; showNotification(`å·²å¯åŠ¨ ${ok}/${ports.length} ä¸ªç«¯å£`,'success'); }
    async function batchStopAll(){ if(!ports.length) return showNotification('æ²¡æœ‰å¯é‡Šæ”¾çš„ç«¯å£','info'); if(!confirm(`ç¡®å®šè¦é‡Šæ”¾å…¨éƒ¨ ${ports.length} ä¸ªç«¯å£å—ï¼Ÿ`)) return; const r=await fetch('/api/ports/batch/stop-all',{method:'POST'}); const d=await r.json(); if(!r.ok) return showNotification(d.error||'æ‰¹é‡é‡Šæ”¾å¤±è´¥','error'); const ok=d.results.filter(x=>x.success).length; showNotification(`å·²é‡Šæ”¾ ${ok}/${ports.length} ä¸ªç«¯å£`,'success'); }
    async function batchDeleteAll(){ if(!ports.length) return showNotification('æ²¡æœ‰å¯åˆ é™¤çš„ç«¯å£','info'); if(!confirm(`ç¡®å®šè¦åˆ é™¤å…¨éƒ¨ ${ports.length} ä¸ªç«¯å£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return; const r=await fetch('/api/ports/batch/delete-all',{method:'POST'}); const d=await r.json(); if(!r.ok) return showNotification(d.error||'æ‰¹é‡åˆ é™¤å¤±è´¥','error'); showNotification('å·²åˆ é™¤å…¨éƒ¨ç«¯å£','success'); refreshPorts(); }

    // é€šçŸ¥
    function showNotification(message, type='info'){
      const n = document.createElement('div');
      n.style.position='fixed'; n.style.top='20px'; n.style.right='20px'; n.style.padding='12px 16px'; n.style.background='#fff'; n.style.borderLeft= type==='success'?'4px solid #4CAF50': type==='error'?'4px solid #f44336':'4px solid #2196F3'; n.style.borderRadius='6px'; n.style.boxShadow='0 4px 12px rgba(0,0,0,.15)'; n.style.zIndex='2000'; n.textContent = message; document.body.appendChild(n); setTimeout(()=>n.remove(), 3000);
    }

    // åˆå§‹åŒ–
    refreshPorts();

    // ç‚¹å‡»é®ç½©å…³é—­
    document.getElementById('addModal').addEventListener('click', e => { if (e.target.id === 'addModal') closeAddModal(); });
    document.getElementById('editModal').addEventListener('click', e => { if (e.target.id === 'editModal') closeEditModal(); });
  </script>
</body>
</html>
